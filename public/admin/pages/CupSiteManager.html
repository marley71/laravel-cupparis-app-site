<div>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.2.1/themes/default/style.min.css" />
    <v-list c-conf="pageManager" inline-template>
        <div>
            <c-loading v-if="loading"></c-loading>
            <div v-else >
                <div class="row">
                    <div class="col-2">
                        <div><a href="/dashboard">Dashboard</a></div>
                        <div id="jstree" >
                            <ul>
                                <li id="root">
                                    Pagine sito
                                    <ul>
                                        <li :id="row.id" v-for="(row,index) in value">
                                            {{row.menu_it}}
                                            <ul v-if="row.children.length > 0">
                                                <li :id="subitem.id" v-for="(subitem,idx) in row.children">
                                                    {{subitem.menu_it}}
                                                </li>
                                            </ul>
                                        </li>
                                    </ul>
                                </li>



                            </ul>
                        </div>
                        <div><a href="javascript:history.location" v-on:click="showSetting()">Impostazioni Sito</a></div>
                    </div>
                    <div class="col-9 offset-1" id="areaEdit">

                    </div>
                </div>


            </div>
        </div>
    </v-list>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.2.1/jstree.min.js"></script>
<script>
    app.loadResources([
        '/cup_site/components/templates/c-site-page.html',
        '/cup_site/components/js/c-site-page.js',
    ])
    var pageManager = {
        modelName:'cup_site_page',
        fields : ['titolo_it'],
        currentPage : null,
        settings : null,
        pagesType : {},
        methods : {
            completed  : function () {
                var that = this;
                for (var i in that.value) {
                    that.pagesType[that.value[i].id] = that.value[i].type;
                }
                jQuery('#jstree').jstree({
                    "core" : {
                        "themes" : {
                            "variant" : "large"
                        },
                        "check_callback": true,
                        // 'data' : function (obj, callback) {
                        //     callback.call(this, that.value);
                        // },
                        // 'data' : that.value,
                        // 'data' : {
                        //     'url' : function (node) {
                        //         console.log('url',node);
                        //         return node.id === '#' ? '/foorm/cup_site_page' : '/static/3.3.10/assets/ajax_demo_children.json';
                        //     },
                        //     'data' : function (node) {
                        //         console.log('data ',node)
                        //         return {
                        //             'id' : node.id,
                        //             'text' : node.menu_it
                        //         };
                        //     }
                        // }
                    },
                    "types" : {
                        "#" : {
                            "max_children" : 100,
                            "max_depth" : 3,
                            "valid_children" : ["root"]
                        },
                        "root" : {
                            "icon" : "fa fa-globe",
                            "valid_children" : ["default"]
                        },
                        "default" : {
                            "icon" : "fa fa-folder",
                            "valid_children" : ["default","file"]
                        },
                        "file" : {
                            "icon" : "fa fa-file",
                            "valid_children" : []
                        },
                    },
                    "contextmenu":{
                        'items' : function(node) {
                            var items = $.jstree.defaults.contextmenu.items();
                            items.ccp = false;

                            return items;
                        }
                    },
                    "plugins" : [
                        "contextmenu", "dnd", "search",
                        "types", "wholerow", "state"
                    ]
                });
                jQuery('#jstree').on("changed.jstree", function (e, data) {
                    var sel = data.selected;
                    if (sel == 'root')
                        return ;
                    if (Array.isArray(sel)) {
                        sel = sel[0];
                    }
                    console.log('sel',sel);
                    if (!sel)
                        return ;
                    that.showPage(parseInt(sel));
                });
                $('#jstree').on("create_node.jstree", function (e,data) {
                    console.log('create node',e,data);
                    var params = {
                        menu_it : data.node.text,
                        attivo : 1,
                        cup_site_page_id : data.parent=='root'?null:data.parent,
                    };
                    that.savePage(null,params,function (json) {
                        if (json.error) {
                            that.errorDialog(json.msg);
                            return ;
                        }
                        jQuery('#jstree').jstree(true).set_id(data.node, json.result.id);
                    });

                });
                $('#jstree').on("rename_node.jstree", function (e,data) {
                    console.log('rename node',e,data);
                    var params = {
                        menu_it : data.text,
                    };
                    that.savePage(data.node.id,params);
                });
                $('#jstree').on("delete_node.jstree", function (e,data) {
                    console.log('delete node',e,data);
                    that.deletePage(data.node.id);
                });
                $('#jstree').on("dnd_stop.vakata", function (e,data) {
                    console.log('dnd_stop',data);
                    //that.deletePage(data.node.id);
                });
                $('#jstree').on("move_node.jstree", function (e,data) {
                    console.log('dnd_stop2',data);
                    that.updateParentPage(data.node.id,data.parent);
                    //that.deletePage(data.node.id);
                });
                //that.showSetting();
            },
            createPage() {
                var that = this;
                var ref = $('#jstree').jstree(true);
                var sel = ref.get_selected();
                console.log('sel',sel)
                sel = sel[0];


                var r = that.createRoute('create');
                r.setValues({
                    modelName : 'cup_site_page',
                });
                var params = {
                    menu_it : 'new page' + Math.floor(Math.random()*100000),
                    attivo : 1,
                };

                if (sel != 'root') {
                    params['cup_site_page_id'] = sel;

                }
                r.setParams(params);

                Server.route(r,function (json) {
                    if (json.error) {
                        that.errorDialog(json.msg);
                        return ;
                    }
                    var node = {
                        id : json.result.id,
                        text : json.result.menu_it
                    };
                    node.type = sel=='root'?'folder':'file';

                    sel = ref.create_node(sel,node);
                    console.log('nodo creato',sel,node);
                })
            },
            showPage(pk) {

                var that = this;
                if (that.currentPage) {
                    that.currentPage.$destroy();
                }
                var htmlId = 'areaEdit';
                console.log('page type',pk,that.pagesType[pk],that.pagesType)
                var componente = new that.$options.components['c-site-page']({
                    propsData : {
                        cConf : {
                            pk : id,
                            type : that.pagesType[pk]
                        },
                    },
                    ref : 'site-page'
                });
                var id= 'd' + (new Date().getTime());
                jQuery('#'+htmlId).html('<div id="'+id+'" ></div>');
                componente.$mount('#'+id);
                that.currentPage = componente;





                // var that = this;
                // if (that.currentPage) {
                //     that.currentPage.$destroy();
                // }
                // var htmlId = 'areaEdit';
                // pageEdit.pk = pk;
                // var componente = new that.$options.components['v-edit']({
                //     propsData : {
                //         cConf : pageEdit,
                //     },
                //     ref : 'page'
                // });
                // var id= 'd' + (new Date().getTime());
                // jQuery('#'+htmlId).html('<div id="'+id+'" ></div>');
                // componente.$mount('#'+id);
                // that.currentPage = componente;
            },
            showSetting : function () {
                var that = this;
                if (that.settings) {
                    that.settings.$destroy();
                }
                var htmlId = 'areaEdit';
                //settingsEdit.pk = pk;
                var componente = new that.$options.components['v-edit']({
                    propsData : {
                        cConf : settingsEdit,
                    },
                    ref : 'setting'
                });
                var id= 'd' + (new Date().getTime());
                jQuery('#'+htmlId).html('<div id="'+id+'" ></div>');
                componente.$mount('#'+id);
                that.settings = componente;
            },
            deletePage(id) {
                var that = this;
                if (id == 'root')
                    return ;
                var r = that.createRoute('delete');
                r.setValues({
                    modelName : 'cup_site_page',
                });
                r.setParams({
                    id : id,
                })
                Server.route(r,function (json){
                    if (json.error) {
                        that.errorDialog(json.msg);
                        return ;
                    }
                    //that.reload();
                })
            },
            savePage(id,params,callback) {
                var that = this;
                var _cb = callback?callback:function (json) {
                        if (json.error) {
                            that.errorDialog(json.msg);
                            return ;
                        }
                }
                var r = id?that.createRoute('update'):that.createRoute('create');
                var values = {
                    modelName : 'cup_site_page',
                };
                if (id)
                    values.pk = id;
                r.setValues(values);
                r.setParams(params);
                Server.route(r,_cb);
            },
            updateParentPage : function (pageId,parentId) {
                var that = this;
                var params = {};
                params.cup_site_page_id = parentId;
                if (parentId == 'root') {
                    params.cup_site_page_id = null;
                }
                that.savePage(pageId,params);
            }
        }
    }

    // var pageEdit = {
    //     modelName: 'cup_site_page',
    //     actions : ['action-save'],
    //     fieldsConfig : {
    //         content_it : {
    //             type : 'w-texthtml',
    //             template : 'tpl-no'
    //         },
    //         keywords : {
    //             type: 'w-textarea',
    //             template: 'tpl-no'
    //         },
    //         attivo : {
    //             type : 'w-radio',
    //             domainValues : {
    //                 0 : 'non attivo',
    //                 1 : 'attivo'
    //             }
    //         }
    //     }
    // }
    var settingsEdit = {
        modelName : 'cup_site_setting',
        pk : 1,
        fields : ['logo','properties'],
        fieldsConfig: {
            logo : {
                type : 'w-upload',
                uploadType : 'image'
            },
            properties : {
                type : 'w-hasone-real',
                template : 'tpl-full-no',
                viewConf : {
                    fieldsConfig : {
                        slider1 : {
                            type : 'w-select',
                            domainValues : {
                                '' : 'Nessuno',
                                '1' : 'Si',
                            }
                        }
                    }

                }
            }
        }
    }
</script>
